# pandoc-ui: A pyside6-based UI for pandoc


## 1. 产品背景与愿景

* Pandoc 是学术与技术写作圈的事实标准；然而其命令行复杂度让大量非技术用户望而却步。
* 本项目的愿景是：**提供一款轻量、跨平台且零配置的 Pandoc 图形界面，帮助用户高效完成单文件或文件夹批量格式转换**，并让转换参数可重用与可视。

## 2. 目标与范围

* **首要目标**：在三大桌面平台（Windows、macOS、Linux）提供一致的 GUI，支持 Markdown/LaTeX/Org 等主流源格式转 PDF、HTML、DOCX、EPUB 等目标格式。
* **范围内**：单文件转换、递归文件夹批量转换、转换配置快照管理、日志与进度可视化、Nuitka 打包为单文件可执行。
* **范围外**：插件系统、云同步、协同编辑、实时预览与高级模板市场（后续版本可再议）。

## 3. 目标用户与使用场景

* **目标用户画像**

  1. 研究生与教师：需要将 Markdown/LaTeX 批量导出 Word 以满足期刊要求。
  2. 技术博主：希望一键生成 HTML 与 PDF 并发布到个人站点。
  3. 编辑与运营：需批量将客户稿件转换为 EPUB / MOBI 上架电子书平台。
* **核心使用场景**

  * 用户打开 GUI，选择单个 Markdown 文件，指定目标格式（如 PDF），点击“转换”立即得到输出并查看日志。
  * 用户选择一个包含多份文稿的文件夹，设置文件扩展名过滤为 `.md`，设定输出目录后点击“批量转换”，任务队列自动并行处理并显示总体进度。

## 4. 功能需求（FR）

1. **文件/文件夹选择**

   * 程序必须允许用户通过系统文件对话框选择单个文件，或通过目录选择器选择文件夹。
   * 文件夹模式下应支持输入扩展名过滤与递归深度控制。
2. **目标格式与模板配置**

   * 用户能够从下拉框中选择单一目标格式，或在“高级”对话框中配置多格式并行导出。
   * 用户能够为每种格式指定 Pandoc 模板、引用样式文件（CSL）和元数据 YAML。
3. **配置快照管理**

   * 程序允许用户保存当前转换参数为“快照”，并在下次启动时加载或切换。
   * 快照文件采用 JSON，默认保存在用户文档目录，可导入/导出。
4. **转换执行与可视化**

   * 转换任务应在后台线程池中执行，主线程实时接收进度信号并更新进度条。
   * GUI 必须提供日志窗展示 Pandoc 标准输出/错误，每条日志附时间戳，以便排错。
5. **错误处理与失败重试**

   * 如果 Pandoc 未安装或版本过低，程序应弹出对话框提示并提供下载链接。
   * 批量模式下的单个文件失败不应终止整体队列；失败条目应高亮并可手动重试。
6. **设置与国际化**

   * 程序应提供语言下拉框，目前支持简体中文和英文两种界面文本。
   * 所有用户设置序列化到 `settings.json`，避免写注册表或 root 目录。

## 5. 非功能需求（NFR）

* **跨平台一致性**：Windows 10+、macOS 11+、Ubuntu 20.04+ 均应通过手动与 CI 自动测试。
* **性能**：GUI 冷启动时间 ≤ 1 秒；100 个文件批量转换时，队列启动延迟 ≤ 500 ms。
* **发布包体积**：经 Nuitka 打包后，单文件可执行大小 ≤ 35 MB（Windows）/ ≤ 40 MB（macOS 通用）。
* **安全**：打包产物不应包含敏感源码；macOS 包须通过公证，Windows 需签名（可用自签）。
* **可维护性**：核心逻辑与 UI 分离，90 % 覆盖率单元测试，CI 检测 flake8 与 mypy。

## 6. 用户体验与界面（UX）

* **主窗口信息区块**

  * 上侧为“任务配置”表单（文件/文件夹选择、格式、模板、输出路径）。
  * 下侧为“执行状态”分栏（进度条 + Logs Tab）。
* **交互原则**

  * 所有长耗时操作均需禁用相关按钮并给出明确进度反馈。
  * 错误弹窗需提供“复制错误详情”按钮，方便提交 issue。
* **示意 ASCII 快速线框**

  ```text
  ┌─────────────────────────────────────────────┐
  │  文件/文件夹  [_________]   [浏览]          │
  │  扩展名过滤   [  *.md   ]                  │
  │  目标格式     [ PDF ▼ ]  模板 [ default ]  │
  │  输出目录     [_/output ]   [浏览]          │
  │  ────────────────────────────────────────  │
  │  [ 保存快照 ]  [ 加载快照 ]  [ 开始转换 ]   │
  │────────────────────────────────────────────│
  │  ▊▊▊▊▊▊▊▊▊▊▊▊▊▊▊▊▊▊▊ 45 %                  │
  │  Logs:                                     │
  │  12:01 running pandoc article.md …         │
  │  12:02 article.md → article.pdf ✔          │
  └─────────────────────────────────────────────┘
  ```

## 7. 技术方案概述

* **语言/框架**：Python 3.12、PySide6、Qt Designer。
* **依赖管理**： uv；开发依赖包含 pytest、mypy、flake8、black。
* **并发模型**：`QThreadPool + QRunnable`；任务完成信号（自定义）跨线程回主线程更新 UI。
* **打包**：Nuitka `--onefile --enable-plugin=pyside6 --follow-imports`；Windows 用 NSIS 封装安装器，macOS 用 productbuild。
* **CI/CD**：GitHub Actions 三平台矩阵，缓存 Nuitka 构建；Artifact 发布至 Release。

## 8. 里程碑计划

| 阶段      | 目标      | 关键输出                   | 预估时长 |
| ------- | ------- | ---------------------- | ---- |
| Phase 0 | 需求冻结    | 本 PRD、UI 原型            | 3 d  |
| Phase 1 | CLI 核心  | `pandoc_runner.py`、单测  | 5 d  |
| Phase 2 | GUI MVP | `main_window.ui`、单文件转换 | 7 d  |
| Phase 3 | 批量支持    | 线程池、进度条                | 6 d  |
| Phase 4 | 快照与设置   | 快照 CRUD、i18n           | 4 d  |
| Phase 5 | 打包发布    | Nuitka 脚本、安装器          | 5 d  |
| Phase 6 | 质保 & 文档 | 用户手册、CI Badge          | 4 d  |

## 9. 风险与假设

* 假设用户本地已安装 Pandoc；若无则提供下载链接及引导，但不内置完整包以控制体积。
* PySide6 每次小版本升级可能引入 ABI 变化，需要在 CI 中锁定确切版本。
* Nuitka 在少数 Linux 发行版上对 glibc 版本敏感，需通过测试矩阵早期发现。

## 10. 成功指标（KPI）

* v1.0 发布后 30 天内，一键安装成功率 ≥ 95 %。
* GitHub Star 达到 100+；Issue 回报平均关闭时间 ≤ 48 h。
* 用户调查中“易用性”与“稳定性”评分均 ≥ 4/5。
